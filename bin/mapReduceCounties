#!/Users/pkimbrel/.nvm/versions/node/v6.2.1/bin/node

var fs = require('fs');
var _ = require('underscore');

var stateData = JSON.parse(fs.readFileSync('public/data/states.info.json', 'utf8'));
var countyData = JSON.parse(fs.readFileSync('raw/geojson/counties.json', 'utf8'));

var fipsLookup = {};
var statePopluationData = stateData;

_.each(stateData, function (state, key) {
    fipsLookup[state.fips] = key;
});

var countyPopluationData = {};
_.each(countyData.features, function (county) {
    var population = county.properties.DP0010001;

    var state = fipsLookup[county.properties.GEOID10.substr(0,2)];
    
    if (state !== undefined) {
        if (statePopluationData[state].population === undefined) {
            statePopluationData[state].population = population;
        } else {
            statePopluationData[state].population += population;
        }
    }

    var fillKey = "pop1";

    if (population >= 4000000) {
        fillKey = "pop10";
    } else if (population >= 1000000) {
        fillKey = "pop9";
    } else if (population >= 800000) {
        fillKey = "pop8";
    } else if (population >= 600000) {
        fillKey = "pop7";
    } else if (population >= 400000) {
        fillKey = "pop6";
    } else if (population >= 100000) {
        fillKey = "pop5";
    } else if (population >= 50000) {
        fillKey = "pop4";
    } else if (population >= 20000) {
        fillKey = "pop3";
    } else if (population >= 10000) {
        fillKey = "pop2";
    }
    countyPopluationData[county.properties.GEOID10] = {
        "population": population,
        "fillKey": fillKey
    };
});

_.each(statePopluationData, function (state) {
    var fillKey = "pop1";

    if (state.population >= 25000000) {
        fillKey = "pop10";
    } else if (state.population >= 20000000) {
        fillKey = "pop9";
    } else if (state.population >= 10000000) {
        fillKey = "pop8";
    } else if (state.population >= 5000000) {
        fillKey = "pop7";
    } else if (state.population >= 4000000) {
        fillKey = "pop6";
    } else if (state.population >= 3000000) {
        fillKey = "pop5";
    } else if (state.population >= 2000000) {
        fillKey = "pop4";
    } else if (state.population >= 1000000) {
        fillKey = "pop3";
    } else if (state.population >= 500000) {
        fillKey = "pop2";
    }

    state.fillKey = fillKey;
});

fs.writeFileSync('public/data/counties.population.json', JSON.stringify(countyPopluationData, null, 4), 'utf8');
fs.writeFileSync('public/data/state.population.json', JSON.stringify(statePopluationData, null, 4), 'utf8');

