#!/Users/pkimbrel/.nvm/versions/node/v6.2.1/bin/node

var exec = require('child_process').exec;
var fs = require('fs');
var _ = require('underscore');

var stateData = JSON.parse(fs.readFileSync('public/data/states.info.json', 'utf8'));

exec("rm -rRf raw/geojson");
exec("mkdir -p raw/geojson/counties");

var dataFolder = "County_2010Census_DP1";
var shapeFolder = "cb_2015_us_county_5m";

exec("ogr2ogr -f GeoJSON raw/geojson/counties.json raw/data/" + dataFolder + "/" + dataFolder + ".shp", function(error, stdout, stderr) {
    if (error) console.log(error);
    process.stdout.write(stdout);
    process.stderr.write(stderr);
});

_.each(stateData, function(data, state) {
    exec("ogr2ogr -f GeoJSON -where \"STATEFP like ('" + data.fips + "')\" raw/geojson/counties/" + state + ".json raw/shapes/" + shapeFolder + "/" + shapeFolder + ".shp", function(error, stdout, stderr) {
        if (error) console.log(error);
        process.stdout.write(stdout);
        process.stderr.write(stderr);
    });
});
